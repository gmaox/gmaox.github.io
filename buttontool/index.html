<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>按键编辑器</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        #canvas {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #control-panel {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px;
            background: white;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            border-radius: 8px;
        }

        .button {
            position: absolute;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        #crosshair {
            position: absolute;
            background-color: #808080;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            opacity: 0.6;
            /* 半透明效果 */
            display: none;
            /* 初始隐藏 */
        }

        #key-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 300px;
            background: white;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            padding: 10px;
            display: none;
            z-index: 15;
            overflow-y: auto;
            border-radius: 8px;
        }

        #key-selector button {
            width: 40px;
            height: 40px;
            margin: 3px;
            font-size: 16px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        /* 模态框背景 */
        .modal {
            display: none;
            /* 默认隐藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* 模态框内容 */
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            border-radius: 8px;
            text-align: center;
        }

        /* 按钮样式 */
        .modal-buttons button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #confirmButton {
            background-color: #4CAF50;
            color: white;
        }

        #cancelButton {
            background-color: #f44336;
            color: white;
        }

        #confirmRenameButton {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>

<body>

    <div id="control-panel">
        <hr id="panel-title">
        <button id="bubu" onclick="bubu()" style="position: fixed;top: 10px;left: 20px;padding: 5px 5px;font-size: 10px;">(*￣▽￣*) </button>
        <div id="bububu" style="display: none;">
            <button id="40button" onclick="bu(40)" style="position: fixed;top: 10px;left: 20px;padding: 5px 5px;font-size: 10px;">40</button><button id="50button" onclick="bu(50)" style="position: fixed;top: 10px;left: 45px;padding: 5px 5px;font-size: 10px;">50</button><button id="70button" onclick="bu(80)" style="position: fixed;top: 10px;left: 70px;padding: 5px 5px;font-size: 10px;">80</button><button id="1450button" onclick="bu('8x4')" style="position: fixed;top: 10px;left: 95px;padding: 5px 5px;font-size: 10px;">8x4</button><button id="60button" onclick="bu(60)" style="position: fixed;top: 10px;left: 125px;padding: 5px 5px;font-size: 10px;">60</button><button id="1460button" onclick="bu('14x6')" style="position: fixed;top: 10px;left: 145px;padding: 5px 5px;font-size: 10px;">14x6</button>
        </div>
        <label>
            <button id="key-type" onclick="openKeySelector()" style="position: fixed;top: 40px;right: 20px;padding: 5px 5px;font-size: 18px;">A</button>
        </label>
        <div id="independent-sliders-container">
            <label>
                宽度:
                <span id="width-label">&nbsp;&nbsp;&nbsp;50</span> px
                <input type="range" id="key-width" min="20" max="300" value="50" oninput="updateWidthLabel()">
            </label>
            <br>
            <label>
                高度:
                <span id="height-label">&nbsp;&nbsp;&nbsp;50</span> px
                <input type="range" id="key-height" min="20" max="300" value="50" oninput="updateHeightLabel()">
            </label>
        </div>

        <button id="toggle-button" onclick="toggleSliders()" style="position: fixed;top: 10px;right: 20px;padding: 5px 5px;font-size: 10px;">合并滑动条</button>

        <div id="merged-slider-container" style="display: none;">
            <label>
                宽 & 高:
                <span id="merged-label">&nbsp;&nbsp;&nbsp;50</span> px
                <input type="range" id="merged-slider" min="20" max="200" value="50" oninput="updateMergedLabel()">
                <br>
                <button onclick="modifyKeybu()">按键改名</button>
                <button id="relayadd" onclick="relayadd1()">接力添加</button>
            </label>

        </div>
        <button onclick="exportConfig()">导出配置</button>
        <button onclick="importConfig()">导入配置</button>
        <button onclick="toggleDeleteMode()">删除按键</button>
        <button onclick="addButton()">添加按键</button>
        <div id="cf666" style="display: none;position: fixed;top: 10px;left: 70px;padding: 5px 5px;font-size: 10px;">不要尝试重复添加按键,不支持(ー_ー)</div>
        <div id="qtxwz" style="display: none;position: fixed;top: 10px;left: 80px;padding: 5px 5px;font-size: 10px;">请填写完整的按键名称</div>
        <div id="ts666" style="display: none;position: fixed;margin: 0% auto;padding: 5px 5px;font-size: 6px;">点击小横线可将布局移至下方</div>
    </div>

    <div id="canvas" onclick="recordPosition(event)">
        <div id="crosshair"></div>
    </div>

    <!-- 按键选择框 -->
    <div id="key-selector">
        <div id="keys"></div>
    </div>
    <!-- 模态框 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <p>是否导入之前编辑的 JSON 文件？</p>
            <p>
                注意：只能导入由该网页生成的 JSON 文件。如果没有文件，请点取消，网页将使用默认的配置文件。
            </p>
            <p>当你再次点击按键改名按钮关闭名称编辑模式时网页会弹出下载请求，该下载是编辑名称的成品，既可以导入月光也可以导入该网页中。</p>
            <p>Tips:keyboards.json、buttons_config.txt，前者存储名称后者存储布局</p>
            <p style="color:#FF0000;">改名之前先保存已编辑的布局txt，先编辑布局后改名。axx最新版1108疑似不支持导入，可使用旧版。</p>

            <div class="modal-buttons">
                <button id="confirmButton">确定</button>
                <button id="cancelButton">取消</button>
            </div>
        </div>
    </div>
    <!-- 改名模态框 -->
    <div id="renameModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage">目标：<span id="originalKey"></span>，改为什么？</p>
            <input type="text" id="newKeyInput" placeholder="输入新名称" style="width: 80%; height: 40px; font-size: 16px; padding: 10px;" />
            <div class="modal-buttons">
                <button id="cancelRenameButton">取消</button>
                <button id="confirmRenameButton">确定</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" style="display:none;" />
    <input type="file" id="file-input" style="display: none" onchange="handleFileInput(event)" />

    <script>
        let buttons = []; // 存储所有按键的配置信息
        let lastClickPos = {
            x: 0,
            y: 0
        }; // 记录最后一次点击的位置
        const keys = ["Esc", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12", "Del", "触控左", "Home", "End", "PgUp", "PgDn", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "触控", "Ctrl", "Win", "Alt", "Space", "Shift", "Tab", "Enter", "A", "B", "C", "D", "E", "F", "G", "触控右", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "摇杆", "V", "W", "X", "Y", "Z", "Insert", "↑", "↓", "←", "→", "ML", "MR", "MR+", "MM", "十字键"];
        let keyWidth = 50; // 初始化宽度 
        let keyHeight = 50; // 初始化高度
        let deleteMode = false; // 删除模式标志
        let modifyKeyMode = false; //改名模式
        let modifyKeyMode1 = true; //第一次进入显示选择框
        let index = -1; // 按键索引
        let Loadtype = "" //载入标志
        let isMerged = false; //合并标志
        let relayadd = false; //接力标签

        // 用于限制坐标到5的倍数
        function roundToNearest5(value) {
            return Math.round(value / 5) * 5;
        }

        // 初始化按键选择框
        function initKeySelector() {
            const keySelector = document.getElementById("keys");
            keySelector.innerHTML = '';

            // 使用 CSS Grid 布局并设置每行15个按键
            keySelector.style.display = "grid";
            keySelector.style.gridTemplateColumns = "repeat(15, 1fr)"; // 每行15个键
            keySelector.style.gridGap = "0px"; // 按键之间的间距，可以根据需要调整

            keys.forEach(key => {
                const button = document.createElement("button");
                button.innerText = key;
                button.style.width = '50px';
                button.style.height = '50px';
                button.onclick = () => selectKey(key);
                keySelector.appendChild(button);
            });
        }

        // 打开按键选择框
        function openKeySelector() {
            initKeySelector();
            document.getElementById("key-selector").style.display = "block";
        }

        // 选择按键并关闭选择框
        function selectKey(key) {
            document.getElementById("key-type").innerText = key;
            document.getElementById("key-selector").style.display = "none";
        }
        // 更新宽度标签
        function updateWidthLabel() {
            const sliderValue = parseInt(document.getElementById("key-width").value) || 50;
            keyWidth = Math.round(sliderValue / 10) * 10;
            document.getElementById("width-label").innerText = keyWidth < 100 ? `\u00A0\u00A0\u00A0${keyWidth}` : keyWidth;
            updateCrosshairSize();
        }

        // 更新高度标签
        function updateHeightLabel() {
            const sliderValue = parseInt(document.getElementById("key-height").value) || 50;
            keyHeight = Math.round(sliderValue / 10) * 10;
            document.getElementById("height-label").innerText = keyHeight < 100 ? `\u00A0\u00A0\u00A0${keyHeight}` : keyHeight;
            updateCrosshairSize();
        }

        // 更新合并滑动条的值
        function updateMergedLabel() {
            const mergedValue = parseInt(document.getElementById("merged-slider").value) || 50;
            const roundedValue = Math.round(mergedValue / 10) * 10;
            document.getElementById("merged-label").innerText = roundedValue < 100 ? `\u00A0\u00A0\u00A0${roundedValue}` : roundedValue;

            // 同步更新宽度和高度
            keyWidth = roundedValue;
            keyHeight = roundedValue;
            document.getElementById("width-label").innerText = roundedValue < 100 ? `\u00A0\u00A0\u00A0${roundedValue}` : roundedValue;
            document.getElementById("height-label").innerText = roundedValue < 100 ? `\u00A0\u00A0\u00A0${roundedValue}` : roundedValue;
            updateCrosshairSize();
        }
        //开启预设
        function bubu() {
            document.getElementById("bubu").style.display = "none";
            document.getElementById("bububu").style.display = "block";
        }
        //预设实现
        function bu(roundedValue) {
            // 更新标签文本
            document.getElementById("merged-label").innerText = `\u00A0\u00A0\u00A0${roundedValue}`;
            document.getElementById("width-label").innerText = `\u00A0\u00A0\u00A0${roundedValue}`;
            document.getElementById("height-label").innerText = `\u00A0\u00A0\u00A0${roundedValue}`;

            // 设置 keyWidth 和 keyHeight 为 roundedValue
            keyWidth = roundedValue;
            keyHeight = roundedValue;

            // 根据 roundedValue 调整拖动条的值
            document.getElementById("key-width").value = keyWidth;
            document.getElementById("key-height").value = keyHeight;
            document.getElementById("merged-slider").value = keyWidth;

            // 更新光标大小或其他相关操作
            updateCrosshairSize();

            // 如果 roundedValue 为 "" 时，设置为特定值
            if (roundedValue === "8x4") {
                keyWidth = 80;
                keyHeight = 40;
                // 更新显示标签
                document.getElementById("height-label").innerText = `\u00A0\u00A0\u00A0${keyHeight}`;
                document.getElementById("width-label").innerText = `\u00A0\u00A0\u00A0${keyWidth}`;

                // 更新拖动条的值
                document.getElementById("key-width").value = keyWidth;
                document.getElementById("key-height").value = keyHeight;
                document.getElementById("merged-slider").value = keyWidth;

                // 调用更新光标的函数
                updateCrosshairSize();
            }
            if (roundedValue === "14x6") {
                keyWidth = 140;
                keyHeight = 60;
                // 更新显示标签
                document.getElementById("height-label").innerText = `\u00A0\u00A0\u00A0${keyHeight}`;
                document.getElementById("width-label").innerText = `\u00A0\u00A0\u00A0${keyWidth}`;

                // 更新拖动条的值
                document.getElementById("key-width").value = keyWidth;
                document.getElementById("key-height").value = keyHeight;
                document.getElementById("merged-slider").value = keyWidth;

                // 调用更新光标的函数
                updateCrosshairSize();
            }
        }
        // 切换滑动条模式
        function toggleSliders() {
            isMerged = !isMerged;

            if (isMerged) {
                mergeSliders();
            } else {
                restoreSliders();
            }
        }

        // 合并滑动条
        function mergeSliders() {
            document.getElementById("independent-sliders-container").style.display = "none";
            document.getElementById("merged-slider-container").style.display = "block";

            const mergedSlider = document.getElementById("merged-slider");
            mergedSlider.value = Math.min(keyWidth, keyHeight);
            updateMergedLabel();

            document.getElementById("toggle-button").innerText = "恢复滑动条";
        }

        // 恢复独立滑动条
        function restoreSliders() {
            document.getElementById("independent-sliders-container").style.display = "block";
            document.getElementById("merged-slider-container").style.display = "none";

            // 同步宽度和高度到独立滑动条
            document.getElementById("key-width").value = keyWidth;
            document.getElementById("key-height").value = keyHeight;

            document.getElementById("toggle-button").innerText = "合并滑动条";
        }
        // 更新十字框（灰色按键）的尺寸
        function updateCrosshairSize() {
            const crosshair = document.getElementById("crosshair");
            crosshair.style.width = `${keyWidth}px`;
            crosshair.style.height = `${keyHeight}px`;
        }
        // 记录点击位置并显示灰色按键样式
        function recordPosition(event) {
            //rect有毛用，求解，加了反而会导致点击按键边缘定位错误
            //const rect = event.target.getBoundingClientRect();
            //lastClickPos = {
            //    x: roundToNearest5(event.clientX - rect.left - keyWidth/2),
            //    y: roundToNearest5(event.clientY - rect.top - keyHeight/2)
            //};
            lastClickPos = {
                x: roundToNearest5(event.clientX - keyWidth / 2),
                y: roundToNearest5(event.clientY - keyHeight / 2)
            };
            const crosshair = document.getElementById("crosshair");
            crosshair.style.left = `${lastClickPos.x}px`;
            crosshair.style.top = `${lastClickPos.y}px`;
            crosshair.style.display = "flex";
            crosshair.addEventListener("mousedown", (e) => startDrag(e, crosshair));
            crosshair.addEventListener("touchstart", (e) => startDrag(e, crosshair), {
                passive: false
            });
            crosshair.addEventListener("mouseup", stopDrag);
            crosshair.addEventListener("touchend", stopDrag);
            updateCrosshairSize();
        }
        // 添加按键
        function addButton() {
            const type = document.getElementById("key-type").innerText || "按键";
            if (buttons.some(button => button.type === type) && Loadtype.trim() == "") {
                document.getElementById("cf666").style.display = "block";
                setTimeout(function() {
                    document.getElementById("cf666").style.display = "none";
                }, 2000);
                return; // 如果匹配，直接返回
            }
            // 创建按键元素
            const button = document.createElement("div");
            button.className = "button";
            button.style.width = `${keyWidth}px`;
            button.style.height = `${keyHeight}px`;
            button.style.left = `${lastClickPos.x}px`;
            button.style.top = `${lastClickPos.y}px`;
            button.innerText = type;
            if (Loadtype.trim() !== "") {
                button.innerText = Loadtype;
                const buttonConfig = {
                    type: Loadtype,
                    width: keyWidth,
                    height: keyHeight,
                    x: lastClickPos.x,
                    y: lastClickPos.y
                };
                Loadtype = "";
                buttons.push(buttonConfig);
            } else {
                const buttonConfig = {
                    type,
                    width: keyWidth,
                    height: keyHeight,
                    x: lastClickPos.x,
                    y: lastClickPos.y
                };
                buttons.push(buttonConfig);
            };

            // 保存配置信息，存储位置、大小等



            // 添加触摸和鼠标拖动功能
            button.addEventListener("mousedown", (e) => startDrag(e, button));
            button.addEventListener("touchstart", (e) => startDrag(e, button), {
                passive: false
            });
            button.addEventListener("mouseup", stopDragf);
            button.addEventListener("touchend", stopDragf);


            document.getElementById("canvas").appendChild(button);
            if (relayadd) {
                openKeySelector();
            }
        }

        function relayadd1() {
            if (relayadd) {
                document.getElementById("relayadd").innerText = "接力添加";
                relayadd = false;
            } else {
                document.getElementById("relayadd").innerText = "关闭接力";
                relayadd = true;
            }
        }

        function stopDragf(event) {
            const clickedButton = event.target; // 获取被点击的按钮
            if (deleteMode) {
                return;
            };

            if (index > -1) {
                const buttonConfig8 = {
                    type: buttons[index].type,
                    x: parseInt(clickedButton.style.left),
                    y: parseInt(clickedButton.style.top),
                    width: parseInt(clickedButton.style.width),
                    height: parseInt(clickedButton.style.height)
                };
                buttons[index] = buttonConfig8;
            };
        }
        // 删除按键
        function deleteButton(event, button) {
            // 阻止事件冒泡，避免触发canvas的点击事件
            //event.stopPropagation();
            const clickedButton = event.target; // 获取被点击的按钮
            const buttonConfig = [...buttons].reverse().find(config =>
                config.x === parseInt(clickedButton.style.left) &&
                config.y === parseInt(clickedButton.style.top) &&
                config.width === parseInt(clickedButton.style.width) &&
                config.height === parseInt(clickedButton.style.height)
            );
            index = buttons.indexOf(buttonConfig);
            if (deleteMode !== true) {
                return;
            };
            if (index > -1) {
                buttons.splice(index, 1);
                button.remove();
            };
        }
        let keydatadefault = {
            "data": {
                "rocker": [{
                    "name": "摇杆",
                    "elementId": "rocker_1",
                    "leftCode": 29,
                    "rightCode": 32,
                    "upCode": 51,
                    "downCode": 47,
                    "middleCode": 59,
                    "desc": "摇杆"
                }],
                "dpad": [{
                    "name": "十字键",
                    "elementId": "dpad_1",
                    "leftCode": 29,
                    "rightCode": 32,
                    "upCode": 51,
                    "downCode": 47,
                    "desc": "十字键"
                }],
                "mouse": [{
                        "name": "ML",
                        "code": 1,
                        "desc": "ML"
                    },
                    {
                        "name": "MR",
                        "code": 3,
                        "desc": "MR"
                    },
                    {
                        "name": "MR+",
                        "code": 3,
                        "switchButton": 1,
                        "desc": "MR+"
                    },
                    {
                        "name": "MM",
                        "code": 2,
                        "desc": "MM"
                    },
                    {
                        "name": "触控右",
                        "code": 9,
                        "desc": "触控右"
                    },
                    {
                        "name": "触控",
                        "code": 10,
                        "desc": "触控"
                    },
                    {
                        "name": "触控左",
                        "code": 11,
                        "desc": "触控左"
                    }
                ],
                "keystroke": [{
                        "name": "Esc",
                        "code": 111,
                        "desc": "Esc"
                    },
                    {
                        "name": "F1",
                        "code": 131,
                        "desc": "F1"
                    },
                    {
                        "name": "F2",
                        "code": 132,
                        "desc": "F2"
                    },
                    {
                        "name": "F3",
                        "code": 133,
                        "desc": "F3"
                    },
                    {
                        "name": "F4",
                        "code": 134,
                        "desc": "F4"
                    },
                    {
                        "name": "F5",
                        "code": 135,
                        "desc": "F5"
                    },
                    {
                        "name": "F6",
                        "code": 136,
                        "desc": "F6"
                    },
                    {
                        "name": "F7",
                        "code": 137,
                        "desc": "F7"
                    },
                    {
                        "name": "F8",
                        "code": 138,
                        "desc": "F8"
                    },
                    {
                        "name": "F9",
                        "code": 139,
                        "desc": "F9"
                    },
                    {
                        "name": "F10",
                        "code": 140,
                        "desc": "F10"
                    },
                    {
                        "name": "F11",
                        "code": 141,
                        "desc": "F11"
                    },
                    {
                        "name": "F12",
                        "code": 142,
                        "desc": "F12"
                    },
                    {
                        "name": "Del",
                        "code": 112,
                        "desc": "Del"
                    },
                    {
                        "name": "Home",
                        "code": 122,
                        "desc": "Home"
                    },
                    {
                        "name": "End",
                        "code": 123,
                        "desc": "End"
                    },
                    {
                        "name": "PgUp",
                        "code": 92,
                        "desc": "PgUp"
                    },
                    {
                        "name": "PgDn",
                        "code": 93,
                        "desc": "PgDn"
                    },
                    {
                        "name": "1",
                        "code": 8,
                        "desc": "1"
                    },
                    {
                        "name": "2",
                        "code": 9,
                        "desc": "2"
                    },
                    {
                        "name": "3",
                        "code": 10,
                        "desc": "3"
                    },
                    {
                        "name": "4",
                        "code": 11,
                        "desc": "4"
                    },
                    {
                        "name": "5",
                        "code": 12,
                        "desc": "5"
                    },
                    {
                        "name": "6",
                        "code": 13,
                        "desc": "6"
                    },
                    {
                        "name": "7",
                        "code": 14,
                        "desc": "7"
                    },
                    {
                        "name": "8",
                        "code": 15,
                        "desc": "8"
                    },
                    {
                        "name": "9",
                        "code": 16,
                        "desc": "9"
                    },
                    {
                        "name": "0",
                        "code": 7,
                        "desc": "0"
                    },
                    {
                        "name": "Ctrl",
                        "code": 113,
                        "desc": "Ctrl"
                    },
                    {
                        "name": "Win",
                        "code": 117,
                        "desc": "Win"
                    },
                    {
                        "name": "Alt",
                        "code": 57,
                        "desc": "Alt"
                    },
                    {
                        "name": "Space",
                        "code": 62,
                        "desc": "Space"
                    },
                    {
                        "name": "Shift",
                        "code": 59,
                        "desc": "Shift"
                    },
                    {
                        "name": "Tab",
                        "code": 61,
                        "desc": "Tab"
                    },
                    {
                        "name": "Enter",
                        "code": 66,
                        "desc": "Enter"
                    },
                    {
                        "name": "A",
                        "code": 29,
                        "desc": "A"
                    },
                    {
                        "name": "B",
                        "code": 30,
                        "desc": "B"
                    },
                    {
                        "name": "C",
                        "code": 31,
                        "desc": "C"
                    },
                    {
                        "name": "D",
                        "code": 32,
                        "desc": "D"
                    },
                    {
                        "name": "E",
                        "code": 33,
                        "desc": "E"
                    },
                    {
                        "name": "F",
                        "code": 34,
                        "desc": "F"
                    },
                    {
                        "name": "G",
                        "code": 35,
                        "desc": "G"
                    },
                    {
                        "name": "H",
                        "code": 36,
                        "desc": "H"
                    },
                    {
                        "name": "I",
                        "code": 37,
                        "desc": "I"
                    },
                    {
                        "name": "J",
                        "code": 38,
                        "desc": "J"
                    },
                    {
                        "name": "K",
                        "code": 39,
                        "desc": "K"
                    },
                    {
                        "name": "L",
                        "code": 40,
                        "desc": "L"
                    },
                    {
                        "name": "M",
                        "code": 41,
                        "desc": "M"
                    },
                    {
                        "name": "N",
                        "code": 42,
                        "desc": "N"
                    },
                    {
                        "name": "O",
                        "code": 43,
                        "desc": "O"
                    },
                    {
                        "name": "P",
                        "code": 44,
                        "desc": "P"
                    },
                    {
                        "name": "Q",
                        "code": 45,
                        "desc": "Q"
                    },
                    {
                        "name": "R",
                        "code": 46,
                        "desc": "R"
                    },
                    {
                        "name": "S",
                        "code": 47,
                        "desc": "S"
                    },
                    {
                        "name": "T",
                        "code": 48,
                        "desc": "T"
                    },
                    {
                        "name": "U",
                        "code": 49,
                        "desc": "U"
                    },
                    {
                        "name": "V",
                        "code": 50,
                        "desc": "V"
                    },
                    {
                        "name": "W",
                        "code": 51,
                        "desc": "W"
                    },
                    {
                        "name": "X",
                        "code": 52,
                        "desc": "X"
                    },
                    {
                        "name": "Y",
                        "code": 53,
                        "desc": "Y"
                    },
                    {
                        "name": "Z",
                        "code": 54,
                        "desc": "Z"
                    },
                    {
                        "name": "Insert",
                        "code": 124,
                        "desc": "Insert"
                    },
                    {
                        "name": "↑",
                        "code": 19,
                        "desc": "↑"
                    },
                    {
                        "name": "↓",
                        "code": 20,
                        "desc": "↓"
                    },
                    {
                        "name": "←",
                        "code": 21,
                        "desc": "←"
                    },
                    {
                        "name": "→",
                        "code": 22,
                        "desc": "→"
                    }
                ]
            }
        }
        let keydata = keydatadefault
        //按键改名
        let isModalVisible = false; // 标记模态框是否显示

        function modifyKey(event, button) {
            const clickedButton = event.target; // 获取被点击的按钮
            const buttonConfig = [...buttons].reverse().find(config =>
                config.x === parseInt(clickedButton.style.left) &&
                config.y === parseInt(clickedButton.style.top) &&
                config.width === parseInt(clickedButton.style.width) &&
                config.height === parseInt(clickedButton.style.height)
            );
            const originalKey = buttonConfig.type;
            var newKey = "";

            // 动态生成模态框消息内容
            const modalMessage = document.getElementById("modalMessage");
            const newKeyInput = document.getElementById("newKeyInput");

            if (clickedButton.innerText === originalKey) {
                newKeyInput.value = "";
                modalMessage.innerText = `目标：${originalKey}，改为什么？`;
            } else {
                newKeyInput.value = clickedButton.innerText;
                modalMessage.innerText = `目标：${originalKey}，原始值：${clickedButton.innerText}，改为什么？`;
            }

            // 显示模态框
            const modal = document.getElementById("renameModal");
            modal.style.display = "block";
            isModalVisible = true; // 设置标志位为 true，表示模态框正在显示

            // 创建 Promise 以阻塞执行，等待模态框关闭
            const waitForModalClose = new Promise((resolve, reject) => {
                // 点击确认按钮时
                document.getElementById("confirmRenameButton").onclick = function() {
                    newKey = newKeyInput.value.trim();
                    modal.style.display = "none";
                    isModalVisible = false; // 隐藏模态框后，设置标志位为 false
                    resolve(); // 关闭模态框后调用 resolve，继续执行
                };

                // 点击取消按钮时
                document.getElementById("cancelRenameButton").onclick = function() {
                    modal.style.display = "none"; // 隐藏模态框
                    isModalVisible = false; // 隐藏模态框后，设置标志位为 false
                    resolve(); // 关闭模态框后调用 resolve，继续执行
                };
                newKeyInput.addEventListener("keydown", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault(); // 防止默认的回车行为（例如换行）
                        document.getElementById("confirmRenameButton").click(); // 触发确认按钮点击
                    }
                });
            });

            // 使用 async/await 等待模态框关闭
            async function executeAfterModal() {
                await waitForModalClose; // 等待模态框关闭
                // 继续执行下面的代码

                if (!originalKey || !newKey) {
                    document.getElementById("qtxwz").style.display = "block";
                    setTimeout(function() {
                        document.getElementById("qtxwz").style.display = "none";
                    }, 2000);
                    return;
                }

                let found = false;

                // 遍历数据结构，查找并更新按键名称
                for (let category in keydata.data) {
                    keydata.data[category].forEach((item) => {
                        if (item.desc === originalKey) {
                            item.name = newKey; // 修改按键名称
                            found = true;
                        }
                    });
                }

                if (found) {
                    button.innerText = newKey;
                    console.log(JSON.stringify(keydata, null, 2));
                } else {
                    alert("未找到符合条件的按键！可能是导入文件不正确，请尝试刷新页面解决");
                }
            }

            executeAfterModal(); // 执行等待模态框关闭后的代码
        }
        // 切换删除模式
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            const button = document.querySelector("button[onclick='toggleDeleteMode()']");
            button.style.backgroundColor = deleteMode ? "#f44336" : "#efefef"; // 更改按钮颜色，提示当前模式
            if (modifyKeyMode) {
                modifyKeybu();
            }
        }
        //改名模式
        function modifyKeybu() {
            modifyKeyMode = !modifyKeyMode;
            const button = document.querySelector("button[onclick='modifyKeybu()']");
            button.style.backgroundColor = modifyKeyMode ? "#A2FFC5" : "#efefef"; // 更改按钮颜色提示

            if (modifyKeyMode) {
                if (modifyKeyMode1) {
                    modifyKeyMode1 = !modifyKeyMode1;
                    // 显示模态框
                    const modal = document.getElementById("modal");
                    modal.style.display = "block";

                    // 添加模态框按钮事件
                    document.getElementById("confirmButton").onclick = () => {
                        modal.style.display = "none"; // 隐藏模态框
                        document.getElementById("fileInput").click(); // 触发文件选择框
                    };

                    document.getElementById("cancelButton").onclick = () => {
                        modal.style.display = "none"; // 隐藏模态框
                    };

                    // 文件选择框事件
                    const fileInput = document.getElementById("fileInput");
                    fileInput.addEventListener("change", function(event) {
                        const file = event.target.files[0];
                        if (file && file.type === "application/json") {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    keydata = JSON.parse(e.target.result);
                                    // 遍历 keydata 并处理 name 和 desc 不一致的情况
                                    for (const category in keydata.data) {
                                        const elements = keydata.data[category];

                                        elements.forEach(item => {
                                            // 检查 name 和 desc 是否一致
                                            if (item.name !== item.desc) {
                                                // 在 className 为 "button" 的按钮中寻找 innerText 为 item.desc 的按钮
                                                const buttons = document.querySelectorAll('.button');

                                                buttons.forEach(button => {
                                                    if (button.innerText === item.desc) {
                                                        // 将按钮的 innerText 替换为 item.name
                                                        button.innerText = item.name;
                                                    }
                                                });
                                            }
                                        });
                                    };
                                    document.getElementById("fullscreen-btn").style.display = "block";
                                    console.log("文件内容：", keydata);
                                } catch (error) {
                                    alert("文件内容不是有效的 JSON 格式，请检查文件内容！");
                                    console.error(error);
                                }
                            };
                            reader.onerror = function() {
                                console.error("文件读取失败");
                            };
                            reader.readAsText(file);
                        } else {
                            alert("文件类型不正确，请选择 .txt 文件！");
                        }
                    });
                }
            } else {
                // 导出编辑后的 JSON 文件
                const blob = new Blob([JSON.stringify(keydata, null, 2)], {
                    type: "application/json",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "keyboards.json";
                link.click();
            }
            // 如果处于删除模式，关闭删除模式
            if (deleteMode) {
                toggleDeleteMode();
            }
        }

        // 实现按键拖动
        function startDrag(e, button) {
            
            keyWidth = parseInt(e.target.style.width)
            keyHeight = parseInt(e.target.style.height)
            console.log(keyHeight,keyWidth)
                            // 更新显示标签
            document.getElementById("height-label").innerText = `\u00A0\u00A0\u00A0${keyHeight}`;
            document.getElementById("width-label").innerText = `\u00A0\u00A0\u00A0${keyWidth}`;
                        // 根据 roundedValue 调整拖动条的值
            document.getElementById("key-width").value = keyWidth;
            document.getElementById("key-height").value = keyHeight;
            document.getElementById("merged-slider").value = keyWidth;

            // 更新光标大小或其他相关操作
            updateCrosshairSize();
            
            e.preventDefault(); // 防止触摸事件导致滚动
            deleteButton(e, button);
            if (modifyKeyMode) {
                modifyKey(e, button);
            }
            const rect = button.getBoundingClientRect();
            const offsetX = (e.clientX || e.touches[0].clientX) - rect.left;
            const offsetY = (e.clientY || e.touches[0].clientY) - rect.top;

            function drag(e) {
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                button.style.left = `${roundToNearest5(clientX - offsetX)}px`;
                button.style.top = `${roundToNearest5(clientY - offsetY)}px`;
                //console.log("Updated buttonConfig:", clientX);
                //lastClickPos = {
                //    x: roundToNearest5(clientX - (keyWidth / 2)),
                //    y: roundToNearest5(clientY - (keyHeight / 2))
                //};

            }
            console.log(e);

            function stopDrag() {

                document.removeEventListener("mousemove", drag);
                document.removeEventListener("mouseup", stopDrag);
                document.removeEventListener("touchmove", drag);
                document.removeEventListener("touchend", stopDrag);
            }

            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", stopDrag);
            document.addEventListener("touchmove", drag, {
                passive: false
            });
            document.addEventListener("touchend", stopDrag);
        }
        // 停止拖动并更新位置信息// 
        //  document.addEventListener("touchend", function(event) {
        // 获取触摸结束时的全局位置
        //const touch = event.changedTouches[0]; // 获取触摸点
        //   const globalTouchX = touch.pageX;
        //    const globalTouchY = touch.pageY;

        //    console.log("全局触摸位置：", globalTouchX, globalTouchY);});
        function stopDrag(event) {
            const crosshair = document.getElementById("crosshair");
            if (!crosshair) {
                console.error("未找到 ID 为 'crosshair' 的元素。");
                return;
            }

            const rect = crosshair.getBoundingClientRect();

            // 记录位置信息
            const elementTop = rect.top;
            const elementLeft = rect.left;
            const elementWidth = rect.width;
            const elementHeight = rect.height;

            // 打印位置信息
            console.log(`crosshair 元素位置: top = ${elementTop}px, left = ${elementLeft}px, width = ${elementWidth}px, height = ${elementHeight}px`);
            lastClickPos = {
                x: roundToNearest5(elementLeft), // 确认 roundToNearest5 函数是否定义
                y: roundToNearest5(elementTop) // 确认 roundToNearest5 函数是否定义
            };
        }

        let typeMap = {
            "H": "key_36",
            "I": "key_37",
            "J": "key_38",
            "K": "key_39",
            "L": "key_40",
            "M": "key_41",
            "N": "key_42",
            "O": "key_43",
            "P": "key_44",
            "Q": "key_45",
            "R": "key_46",
            "S": "key_47",
            "T": "key_48",
            "U": "key_49",

            "触控左": "m_11",
            "触控": "m_10",
            "触控右": "m_9",

            "Esc": "key_111",
            "F1": "key_131",
            "F2": "key_132",
            "F3": "key_133",
            "F4": "key_134",
            "F5": "key_135",
            "F6": "key_136",
            "F7": "key_137",
            "F8": "key_138",
            "F9": "key_139",
            "F10": "key_140",
            "F11": "key_141",
            "F12": "key_142",
            "Del": "key_112",

            "摇杆": "rocker_1",
            "十字键": "dpad_1",

            "Ctrl": "key_113",
            "Win": "key_117",
            "Alt": "key_57",
            "Space": "key_62",
            "Shift": "key_59",
            "Tab": "key_61",
            "Enter": "key_66",
            "A": "key_29",
            "B": "key_30",
            "C": "key_31",
            "D": "key_32",
            "E": "key_33",
            "F": "key_34",
            "G": "key_35",

            "V": "key_50",
            "W": "key_51",
            "X": "key_52",
            "Y": "key_53",
            "Z": "key_54",
            "Insert": "key_124",
            "↑": "key_19",
            "↓": "key_20",
            "←": "key_21",
            "→": "key_22",
            "ML": "m_1",
            "MR": "m_3",
            "MR+": "m_s_3",
            "MM": "m_2",

            "Home": "key_122",
            "End": "key_123",
            "PgUp": "key_92",
            "PgDn": "key_93",
            "1": "key_8",
            "2": "key_9",
            "3": "key_10",
            "4": "key_11",
            "5": "key_12",
            "6": "key_13",
            "7": "key_14",
            "8": "key_15",
            "9": "key_16",
            "0": "key_7",
        };
        // 导出配置
        function exportConfig() {
            const config = buttons.map(button => ({
                type: button.type,
                width: button.width,
                height: button.height,
                x: roundToNearest5(button.x),
                y: roundToNearest5(button.y)
            }));

            let convertedData = {};
            config.forEach((item, index) => {
                let key = typeMap[item.type];
                if (key) {
                    convertedData[key] = JSON.stringify({
                        LEFT: item.x * window.devicePixelRatio,
                        TOP: item.y * window.devicePixelRatio,
                        WIDTH: item.width * window.devicePixelRatio,
                        HEIGHT: item.height * window.devicePixelRatio,
                        ENABLED: true
                    });
                }
            });
            for (let type in typeMap) {
                let key = typeMap[type];
                if (!convertedData[key]) {
                    convertedData[key] = JSON.stringify({
                        LEFT: 0,
                        TOP: 0,
                        WIDTH: 0,
                        HEIGHT: 0,
                        ENABLED: false
                    });
                }
            }
            console.log(JSON.stringify(convertedData, null, 4));

            const blob = new Blob([JSON.stringify(convertedData, null, 2)], {
                type: "text/plain"
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "buttons_config.txt";
            link.click();
        }

        // 导入配置
        function importConfig() {
            document.getElementById("fullscreen-btn").style.display = "block";
            document.getElementById("file-input").click();
        }

        // 处理导入文件
        function handleFileInput(event) {
            const file = event.target.files[0];
            if (file && file.type === "text/plain") {
                //导入前初始化
                buttons = [];
                // 获取所有类名为 "button" 的元素
                const buttonsi = document.querySelectorAll(".button");
                // 遍历每个元素并从 DOM 中删除
                buttonsi.forEach(button => {
                    button.remove();
                });
                const reader = new FileReader();
                reader.onload = function(e) {
                    const config = JSON.parse(e.target.result);

                    // 遍历导入的 JSON
                    for (const [key, value] of Object.entries(config)) {
                        // 二次解析嵌套的 JSON 字符串
                        const parsedValue = JSON.parse(value);
                        console.log(value);
                        // 检查 ENABLED 是否为真
                        if (parsedValue.ENABLED) {
                            console.log(key);
                            Loadtype = key;
                            for (const [key, value] of Object.entries(typeMap)) {
                                if (value === Loadtype) {
                                    Loadtype = key; // 替换为键
                                    break; // 如果只需要替换第一个匹配项，可以在找到后退出循环
                                }
                                console.log(Loadtype);
                            }
                            keyHeight = parsedValue.HEIGHT / window.devicePixelRatio;
                            keyWidth = parsedValue.WIDTH / window.devicePixelRatio;
                            lastClickPos = {
                                x: parsedValue.LEFT / window.devicePixelRatio,
                                y: parsedValue.TOP / window.devicePixelRatio
                            };

                            // 调用 addButton，并传递参数
                            addButton();
                        }
                    }
                };
                reader.readAsText(file);
            } else {
                alert("请选择有效的配置文件！");
            }

        }

        // 监听标题点击，切换控件面板的位置
        document.getElementById("panel-title").addEventListener("click", function() {
            const controlPanel = document.getElementById("control-panel");
            const isAtBottom = controlPanel.style.top === "60%";

            if (isAtBottom) {
                controlPanel.style.top = "10px"; // 复原控件位置
            } else {
                controlPanel.style.top = "60%"; // 将控件移至屏幕 50% 位置
            }
        });
        //initKeySelector(); // 初始化按键选择框
        //document.getElementById("ts666").style.display = "block";
        //setTimeout(function() {
        //    document.getElementById("ts666").style.display = "none";
        //}, 5000);
    </script>
    <button id="fullscreen-btn" onclick="enterFullScreen()" style="position: fixed;top: 10px;right: 10px;padding: 10px 20px;font-size: 18px;background-color: #4CAF50;color: white;border: none;border-radius: 5px;cursor: pointer;z-index: 1000;transition: background-color 0.3s;">进入全屏</button>
    <script>
        // 进入全屏模式
        function enterFullScreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { // Firefox
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { // Chrome, Safari, Opera
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { // IE/Edge
                element.msRequestFullscreen();
            }

            // 隐藏按钮
            document.getElementById("fullscreen-btn").style.display = "none";
        }
    </script>
</body>
</html>
